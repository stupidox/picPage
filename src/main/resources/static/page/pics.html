<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>图片</title>
</head>
<body>
<h1 style="text-align: center"></h1>
<select id="dirPath" placeholder="文件夹...">
    <option value="E:\private\pics">E:\private\pics</option>
    <option value="D:\private\pictures">D:\private\pictures</option>
    <option value="F:\aiPics">F:\aiPics</option>
</select>
<div id="dirList"></div>
<div id="picList"></div>
</body>
<script type="text/javascript" src="/js/jquery/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="/js/common.js"></script>
<script type="text/javascript" src="/js/jquery/jquery-confirm.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/all.css">
<link rel="stylesheet" type="text/css" href="/css/jquery-confirm.min.css">
<script type="text/javascript">
    let outter = '0';
    let timer;
    // 设置键盘翻页
    $(document).keyup(function(event){
        if (event.keyCode === 37) {
            $(".pre").click();
        } else if (event.keyCode === 39) {
            $(".next").click();
        }
    });

    // 删除次目录下的所有文件
    function deleteDir() {
        $.confirm({
            title: '删除',
            content: '确认删除该目录下的所有文件!',
            boxWidth: '400px',
            useBootstrap: false,
            onOpenBefore: function () {
                if (outter === '1') {
                    $('.jconfirm-box').css('width', '80%');
                    $('.jconfirm-buttons').css('width', '90%')
                    $('.jconfirm-buttons button').css('width', '45%').css('height', '70px')
                }
            },
            buttons: {
                '确认': function () {
                    const params = new URLSearchParams(window.location.search);
                    const path = encode(params.get('path'));
                    const dir = encode(params.get('dir'));
                    let rootPath = encode(params.get('rootPath'));
                    $.ajax({
                        type: "GET",
                        contentType: "application/json",
                        url: "/comic/deleteDir",
                        data: {path: path, dir: dir, rootPath: rootPath},
                        dataType: 'json',
                        success: function (data) {
                            if ($('.j-next').length > 0) {
                                $('.j-next').get(0).click()
                            } else if ($('.j-pre').length > 0) {
                                $('.j-pre').get(0).click()
                            } else {
                                $('#goDir').get(0).click()
                            }
                        },
                        error: function (e) {
                        }
                    });
                },
                '取消': function () {

                }
            }
        });
    }

    function getPathInfo(rootPath, dir, path) {
        $.ajax({
            type: "GET",
            contentType: "application/json",
            url: "/comic/pic",
            data: {path: path, dir: dir, rootPath: rootPath},
            dataType: 'json',
            success: function (data) {
                let res = '';
                let parentName = getParentName(dir);
                let pParentPath = getPParentPath(dir);
                res += '<div class="follow-div">'
                if (dir != null && dir !== '' && parentName !== pParentPath) {
                    res += '<a id="goDir" lastPage="' + path + '" href="./pics.html?path=' + encode(parentName) + '&rootPath=' + encode(rootPath)
                    res += '&dir=' + encode(pParentPath) + '">目录</a>';
                } else if (dir != null && dir !== '' && parentName === pParentPath){
                    res += '<a id="goDir" lastPage="' + path + '" href="./pics.html?path=' + encode(parentName) + '&rootPath=' + encode(rootPath)
                    res += '&dir=">目录</a>';
                } else {
                    res += '<a id="goDir" lastPage="' + path + '" href="./pics.html?path=&rootPath=' + encode(rootPath)
                    res += '&dir=">目录</a>';
                }
                res += '<div><a id="delDir" href="javascript:void(0)" onclick="deleteDir()" >删除</a></div>'
                res += '</div>'
                let dirInfo = '';
                if (data.pre !== undefined && data.pre != null && data.pre !== '') {
                    dirInfo += '<a class="jump j-pre" data-j="./pics.html?path=' + encode(data.pre) + '&dir=' + encode(dir) +
                        '&rootPath='+ encode(rootPath) + '"><button class="button mid pre">上一章</button></a>'
                }
                if (data.next !== undefined && data.next != null && data.next !== '') {
                    dirInfo += '<a class="jump j-next" data-j="./pics.html?path=' + encode(data.next) + '&dir=' + encode(dir) +
                        '&rootPath='+ encode(rootPath) + '"><button class="button mid next">下一章</button></a>'
                }
                if (typeof(data.dirList) != "undefined") {
                    for (let i = 0; i < data.dirList.length; i++) {
                        dirInfo += '<a class="name" href="javascript:void(0)" data-p="' + data.dirList[i] + '">'
                            + data.dirList[i] + '</a><div style="next"></div>';
                    }
                }
                $('#dirList').html(dirInfo);
                if (typeof(data.fileList) != "undefined") {
                    if (dir != null && dir !== '' && path != null && path !== '') {
                        for (let i = 0; i < data.fileList.length; i++) {
                            res += '<div class="img-container"><div class="overlay">删除</div>'
                            res += '<img src="/' + dir + '/' + path + '/' + data.fileList[i] + '"/>';
                            res += '</div>'
                        }
                    } else if (path != null && path !== '') {
                        for (let i = 0; i < data.fileList.length; i++) {
                            res += '<div class="img-container"><div class="overlay">删除</div>'
                            res += '<img src="/' + path + '/' + data.fileList[i] + '"/>';
                            res += '</div>'
                        }
                    }/* else {
                        for (let i = 0; i < data.fileList.length; i++) {
                            res += '<div class="img-container"><div class="overlay">删除</div>'
                            res += '<img src="/' + data.fileList[i] + '"/>';
                            res += '</div>'
                        }
                    } */
                }
                if (data.pre !== undefined && data.pre != null && data.pre !== '') {
                    res += '<a class="jump j-pre" data-j="./pics.html?path=' + encode(data.pre) + '&dir=' + encode(dir)
                        +'&rootPath=' + encode(rootPath) + '"><button class="button mid">上一章</button></a>'
                }
                if (data.next !== undefined && data.next != null && data.next !== '') {
                    res += '<a class="jump j-next" data-j="./pics.html?path=' + encode(data.next) + '&dir=' + encode(dir)
                        +'&rootPath='+ encode(rootPath) + '"><button class="button mid">下一章</button></a>'
                }
                $('#picList').html(res);

                if (data.out === '1') {
                    $('img').addClass('picOut');
                    $('#goDir').addClass('aOut');
                    $('#delDir').addClass('aOut');
                    $('#dirPath').addClass('selectOut');
                    $('.button').addClass('buttonOut');
                    $('.name').addClass('dOut')
                    outter = '1'
                }

                $(".name").click(function(){
                    const subPath = $(this).data("p")
                    let rpath;
                    if (dir == null || dir === ''){
                        rpath = path;
                    } else {
                        rpath = dir + '\\' + path
                    }
                    $.ajax({
                        type: "GET",
                        contentType: "application/json",
                        url: "/comic/pathInfo",
                        data: {path: encode(subPath), dir: encode(rpath)},
                        dataType: 'json',
                        success: function (data1) {
                            window.location.href = './pics.html?path=' + encode(data1.path) + '&rootPath=' + encode(rootPath)
                                + '&dir=' + encode(data1.dir)
                        },
                        error: function (e) {
                        }
                    });
                });

                initCotent();
            },
            error: function (e) {
            }
        });
    }
    // 目录切换
    function openDir() {
        const val = encode($('#dirPath').val());
        getPathInfo(val, null, null)
    }

    // 初始化页面
    $(function (){
        const params = new URLSearchParams(window.location.search);
        const path = encode(params.get('path'));
        const dir = encode(params.get('dir'));
        let rootPath = encode(params.get('rootPath'));
        if (rootPath != null && rootPath !== "") {
            rootPath = rootPath.replaceAll("/", "\\");
            $('#dirPath').val(rootPath);
        } else {
            $('#dirPath').val('E:\\private\\pics');
            rootPath = "E:\\private\\pics";
        }
        if (path != null && path !== '') {
            $('h1').html(path);
            $('title').html(path);
        } else {
            $('h1').html(dir);
        }
        $('#dirPath').on('change', openDir);
        getPathInfo(rootPath, dir, path);
    })

    // 页面内容加载后的方法
    function initCotent(){
        $(".jump").click(function(){
            window.location.href = $(this).data('j');
        });

        // 长按图片能删除图片
        $('.img-container').on('mousedown', function (){
            const t = $(this);
            timer = setTimeout(function (){
                t.find('.overlay').fadeIn(10);
            }, 700)
        });

        $('.img-container').on('mouseup', function (){
            const t = $(this);
            if ($(this).find('.overlay').is(':visible')) {
                setTimeout(function () {
                    t.find('.overlay').fadeOut(10);
                }, 2300)
            }
            clearTimeout(timer);
        })

        $('.img-container').on('touchstart', function (){
            const t = $(this);
            timer = setTimeout(function (){
                t.find('.overlay').fadeIn(10);
            }, 700)
        });

        $('.img-container').on('touchend', function (){
            const t = $(this);
            if ($(this).find('.overlay').is(':visible')) {
                setTimeout(function () {
                    t.find('.overlay').fadeOut(10);
                }, 2300)
            }
            clearTimeout(timer);
        });

        // 删除图片
        $('.overlay').on('click', function (){
            const src = encode($(this).next().attr('src'));
            const t = $(this);
            $.confirm({
                title: '删除',
                content: '确认删除该图片!',
                boxWidth: '400px',
                useBootstrap: false,
                onOpenBefore: function () {
                    if (outter === '1') {
                        $('.jconfirm-box').css('width', '80%');
                        $('.jconfirm-buttons').css('width', '90%')
                        $('.jconfirm-buttons button').css('width', '45%').css('height', '70px')
                    }
                },
                buttons: {
                    '确认': function () {
                        const params = new URLSearchParams(window.location.search);
                        let rootPath = encode(params.get('rootPath'));
                        $.ajax({
                            type: "GET",
                            contentType: "application/json",
                            url: "/comic/deletePic",
                            data: {rootPath: rootPath, loc: src},
                            dataType: 'json',
                            success: function (data) {
                                t.parent().remove();
                            },
                            error: function (e) {
                            }
                        });
                    },
                    '取消': function () {

                    }
                }
            });
        });
    }

    // 再页面卸载时记录滚动位置
    $(window).on('beforeunload', function (){
        // 获取当前的滚动位置
        const scrollPosition = $(window).scrollTop();
        // 将滚动位置存储到localStorage
        localStorage.setItem('scrollPosition', scrollPosition)
    })

</script>
</html>